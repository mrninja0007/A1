name: A1

on:
  schedule:
    - cron: "0 */5 * * *" # Jalan tiap 5 jam
  workflow_dispatch:

jobs:
  verusmine:
    runs-on: ubuntu-latest
    timeout-minutes: 300 # Maks 5 jam jalan

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git build-essential cmake automake libcurl4-openssl-dev

    - name: Clone ccminer hybrid
      run: |
        git clone https://github.com/monkins1010/ccminer.git
        cd ccminer
        mkdir build
        cd build
        cmake ..
        make -j$(nproc)
        cp ccminer .. # Copy binary ke direktori atas

    - name: Start mining (Luckpool Hybrid Mode)
      run: |
        cd ccminer

        # ‚Äî‚Äî‚Äî‚Äî‚Äî KONFIGURASI ‚Äî‚Äî‚Äî‚Äî‚Äî
        WALLET="RGVmtuvrP2yX8q3U4up77CcSpkcVhp4bUG"
        POOL="stratum+tcp://ap.luckpool.net:3956#xnsub"
        PASSWORD="hybrid"
        THREADS=2
        WORKER="A1"
        LOG_FILE="log.txt"

        TELEGRAM_TOKEN="7548058927:AAF-fL3P6W5sNxbzbmwwtsfVxPZubdIybzc"
        TELEGRAM_CHAT_ID="5763229296"

        # ‚Äî‚Äî‚Äî‚Äî‚Äî FUNGSI TELEGRAM ‚Äî‚Äî‚Äî‚Äî‚Äî
        send_telegram() {
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d parse_mode=Markdown \
            -d text="$1"
        }

        send_telegram "‚õèÔ∏è *Mining dimulai* sebagai *$WORKER* (mode *hybrid*, AP) dengan *$THREADS* thread."

        # ‚Äî‚Äî‚Äî‚Äî‚Äî JALANKAN MINER ‚Äî‚Äî‚Äî‚Äî‚Äî
        rm -f "$LOG_FILE"
        ./ccminer -a verus \
                  -o $POOL \
                  -u $WALLET.$WORKER \
                  -p $PASSWORD \
                  -t $THREADS | tee "$LOG_FILE" &

        MINER_PID=$!

        # ‚Äî‚Äî‚Äî‚Äî‚Äî Pantau share accepted ‚Äî‚Äî‚Äî‚Äî‚Äî
        tail -F "$LOG_FILE" | while read LINE; do
          if echo "$LINE" | grep -q "accepted"; then
            TOTAL=$(grep -c "accepted" "$LOG_FILE")
            send_telegram "üéâ *Share accepted* ke‚Äë$TOTAL di *$WORKER*"
          fi
        done & TAIL_PID=$!

        # ‚Äî‚Äî‚Äî‚Äî‚Äî Watchdog crash ‚Äî‚Äî‚Äî‚Äî‚Äî
        while sleep 60; do
          if ! kill -0 $MINER_PID 2>/dev/null; then
            send_telegram "‚ùå *Miner crash* di *$WORKER*."
            break
          fi
        done

        kill $TAIL_PID
        TOTAL=$(grep -c "accepted" "$LOG_FILE")
        send_telegram "‚úÖ *Mining selesai* di *$WORKER*. Total accepted: *$TOTAL*"
